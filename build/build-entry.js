const components = require('../components.json')
const fs = require('fs')
const path = require('path')
const packageConfig = require('../package')

const firstLetterToUpperCase = name => (name[0].toUpperCase() + name.slice(1))

const outputPath = path.resolve(__dirname, '../src/index.js')
const componentKeys = Object.keys(components)
const componentsImport = componentKeys.map(component => {
  return `import ${firstLetterToUpperCase(component)} from '../packages/${component}'`
}).join('\n')

const upperComponents = componentKeys.map(component => {
  return firstLetterToUpperCase(component)
})
const componentsList = upperComponents.filter(component => {
  return ['Loading', 'MessageBox'].indexOf(component) === -1
})

const outputContent = `
/* Automatically generated by './build/build-entry.js' */

${componentsImport}
import locale from './locale'

const components = [
${componentsList.map(component => `  ${component}`).join(',\n')},
  Loading.Indicator,
  MessageBox.jmMessageBox
]

const install = (Vue, config = {}) => {
  locale.use(config.locale)
  locale.i18n(config.i18n)

  components.forEach(component => {
    Vue.component(component.name, component)
  })

  Vue.prototype.$toast = Toast
  Vue.prototype.$loading = Loading.loading
  Vue.prototype.$messageBox = MessageBox.MessageBox

  Vue.use(Lazyload, config.lazyload)
}

if (typeof window !== 'undefined' && window.Vue) {
  install(window.Vue)
}

export default {
  version: '${packageConfig.version}',
${upperComponents.map(component => `  ${component}`).join(',\n')}
}
`
fs.writeFileSync(outputPath, outputContent, 'utf-8')